###########################GENuS data extraction########################

library(gdata)
library(readr)
library(tidyverse) # for general data wrangling and plotting
library(rgeos)
library(scales)
library(gdata)
library(rfishbase)
library(openxlsx)

##Read GENuS data
genus_edible_food_by_cntry_year <- readRDS("C:/Users/Daniel/Google Drive/MPAs and Human Nutrition/Data/Nutrition Data/Human Dietary and Nutrition Data/GENuS Data/clean/genus_edible_food_by_cntry_year.Rds")

#Animal sourced food - ASF
# Bovine Meat
# Mutton & Goat Meat
# Pigmeat
# Poultry Meat
# Bird meat; nes
# Horse meat
# Meat of asses
# Meat of mules
# Camel meat
# Rabbit meat
# Meat of other rodents
# Meat of other camelids
# Game meat
# Meat; dried; nes
# Meat; nes
# Snails; not sea
# Offals of cattle; edible
# Offals of sheep; edible
# Offals of goats; edible
# Offals of pigs; edible
# Offals; liver; chicken
# Offals; liver; geese
# Offals; liver; duck
# Offals; nes
# Fats; Animals; Raw
# Hen eggs; in shell
# Eggs; liquid
# Eggs; dried
# Other bird eggs; in shell

###Seafood 
# Fish; Body Oil
# Fish; Liver Oil
# Freshwater Fish
# Demersal Fish
# Pelagic Fish
# Marine Fish; Other
# Crustaceans
# Cephalopods
# Molluscs; Other
# Aquatic Animals; Others

##############################Calculate Fish as proportion of ASF###############
prop_asf = genus_edible_food_by_cntry_year %>% 
  filter(year=="2011") %>%
  drop_na(g_person_day) %>% 
  mutate(value_med = if_else(food=="Aquatic Animals; Others", g_person_day/2, g_person_day))

asf_foods = prop_asf %>% 
  filter(food %in% c("Bovine Meat",
                     "Mutton & Goat Meat",
                     "Pigmeat",
                     "Poultry Meat",
                     "Bird meat; nes",
                     "Horse meat",
                     "Meat of asses",
                     "Meat of mules",
                     "Camel meat",
                     "Rabbit meat",
                     "Meat of other rodents",
                     "Meat of other camelids",
                     "Game meat",
                     "Meat; dried; nes",
                     "Meat; nes",
                     "Snails; not sea",
                     "Offals of cattle; edible",
                     "Offals of sheep; edible",
                     "Offals of goats; edible",
                     "Offals of pigs; edible",
                     "Offals; liver; chicken",
                     "Offals; liver; geese",
                     "Offals; liver; duck",
                     "Offals; nes",
                     "Fats; Animals; Raw",
                     "Hen eggs; in shell",
                     "Eggs; liquid",
                     "Eggs; dried",
                     "Other bird eggs; in shell")) %>%
  group_by(country_use, iso3_use) %>% 
  summarize(asf_without_seafood = sum(g_person_day))

asf_marine = prop_asf %>% 
  filter(food %in% c("Fish; Body Oil",
                     "Fish; Liver Oil",
                     "Demersal Fish",
                     "Pelagic Fish",
                     "Marine Fish; Other",
                     "Crustaceans",
                     "Cephalopods",
                     "Molluscs; Other",
                     "Aquatic Animals; Others")) %>% 
  group_by(country_use) %>% 
  summarize(asf_marine = sum(g_person_day))

asf_freshwater = prop_asf %>% 
  filter(food %in% c("Freshwater Fish",
                     "Aquatic Animals; Others")) %>% 
  group_by(country_use) %>% 
  summarize(asf_freshwater = sum(g_person_day))

prop_asf = left_join(asf_foods, asf_marine, by="country_use")
prop_asf = left_join(prop_asf, asf_freshwater, by="country_use")

prop_asf = prop_asf %>% 
  mutate(total_asf = asf_without_seafood + asf_marine + asf_freshwater,
         perc_marine = 100*asf_marine/total_asf,
         perc_freshwater = 100*asf_freshwater/total_asf,
         perc_aquatic_foods = perc_marine + perc_freshwater) %>%
  mutate(marine_condition = if_else(perc_marine>20,3,if_else(perc_marine>10,2,if_else(perc_marine>5,1,0)))) %>%  
  mutate(freshwater_condition = if_else(perc_freshwater>20,3,if_else(perc_freshwater>10,2,if_else(perc_freshwater>5,1,0)))) %>%  
  mutate(aquatic_condition = if_else(perc_aquatic_foods>50,3,if_else(perc_aquatic_foods>25,2,if_else(perc_aquatic_foods>10,1,0)))) %>%  
  rename(country = country_use)

#write.csv(prop_asf, "asf_fish_proportion.csv", row.names=FALSE)






##################Seafood and freshwater fish total by country
genus_nutrient_supplies_by_cntry_food_2011 <- readRDS("C:/Users/Daniel/Google Drive/MPAs and Human Nutrition/Data/Nutrition Data/Human Dietary and Nutrition Data/GENuS Data/clean/genus_nutrient_supplies_by_cntry_food_2011.Rds")

genus_nutrient_supplies_by_cntry_food_2011 = genus_nutrient_supplies_by_cntry_food_2011 %>%
  mutate(value_med = if_else(food=="Aquatic Animals; Others", value_med/2, value_med))
  
  
marine_by_country = genus_nutrient_supplies_by_cntry_food_2011 %>% 
  filter(nutrient %in% c("Iron", "Zinc", "Vitamin A"),
         food %in% c("Fish; Body Oil",
                     "Fish; Liver Oil",
                     "Demersal Fish",
                     "Pelagic Fish",
                     "Marine Fish; Other",
                     "Crustaceans",
                     "Cephalopods",
                     "Molluscs; Other",
                     "Aquatic Animals; Others")) %>%
  drop_na(value_med) %>% 
  group_by(country_use, nutrient) %>% 
  summarize(marine_supply = sum(value_med)) %>% 
  spread(nutrient, marine_supply) %>% 
  rename(zinc_marine = Zinc, iron_marine = Iron, vitA_marine = "Vitamin A")

freshwater_by_country = genus_nutrient_supplies_by_cntry_food_2011 %>% 
  filter(nutrient %in% c("Iron", "Zinc", "Vitamin A"),
         food %in% c("Freshwater Fish",
                     "Aquatic Animals; Others")) %>%
  drop_na(value_med) %>% 
  group_by(country_use, nutrient) %>% 
  summarize(freshwater_supply = sum(value_med)) %>% 
  spread(nutrient, freshwater_supply) %>% 
  rename(zinc_freshwater = Zinc, iron_freshwater = Iron, vitA_freshwater = "Vitamin A")

total_by_country = genus_nutrient_supplies_by_cntry_food_2011 %>% 
  filter(nutrient %in% c("Iron", "Zinc", "Vitamin A")) %>% 
  drop_na(value_med) %>% 
  group_by(country_use, nutrient) %>% 
  summarize(total_supply = sum(value_med)) %>% 
  spread(nutrient, total_supply) %>% 
  rename(zinc_total = Zinc, iron_total = Iron, vitA_total = "Vitamin A")


nutrient_supply = left_join(marine_by_country, freshwater_by_country, by="country_use")
nutrient_supply = left_join(nutrient_supply, total_by_country, by="country_use")

nutrient_supply = nutrient_supply %>% 
  mutate(zinc_seafood = zinc_marine + zinc_freshwater,
         iron_seafood = iron_marine + iron_freshwater,
         vitA_seafood = vitA_marine + vitA_freshwater,
         prop_freshwater_zinc = zinc_freshwater/zinc_total,
         prop_freshwater_iron = iron_freshwater/iron_total,
         prop_freshwater_vitA = vitA_freshwater/vitA_total,
         prop_marine_zinc = zinc_marine/zinc_total,
         prop_marine_iron = iron_marine/iron_total,
         prop_marine_vitA = vitA_marine/vitA_total,
         prop_seafood_zinc = zinc_seafood/zinc_total,
         prop_seafood_iron = iron_seafood/iron_total,
         prop_seafood_vitA = vitA_seafood/vitA_total,)

#write.csv(nutrient_supply, "seafood_nutrient_supply.csv", row.names=FALSE)

###############Table of intake/(EAR*1.5) per country and age/sex group################################
###First build a table of intake of VitA, Zinc and Iron per country and age/sex group

##Load GENuS data
genus_nutrient_supplies_by_age_sex_2011 <- readRDS("C:/Users/Daniel/Google Drive/MPAs and Human Nutrition/Data/Nutrition Data/Human Dietary and Nutrition Data/GENuS Data/clean/genus_nutrient_supplies_w_fort_by_age_sex_2011.Rds")
##Calculate Miller equation
source("~/Fisheries-Nutrition-Modeling/Nutrient Vulnerability/zinc_absorption_Miller_tidyverse.R")
##replace ingested zinc with absorbed

genus_nutrient_supplies_by_age_sex_2011<-genus_nutrient_supplies_by_age_sex_2011%>%
  left_join(To_replace_zinc, by=c("country_use"="country_use","age_range" = "age_range", "sex" = "sex","nutrient" = "nutrient"))

  genus_nutrient_supplies_by_age_sex_2011<- genus_nutrient_supplies_by_age_sex_2011 %>%
  mutate(value_med1=ifelse(nutrient %in% 'Zinc',zinc_absorb_mg,value_med))%>%
    select(-zinc_absorb_mg,-value_med,-value_hi,-value_lo)%>%
    rename(value_med=value_med1)
  

#Load  and clean EAR data
ear = read_csv("~/MPA_Nutrition/EAR.csv")
ear$Zinc=c(0.6,1,1.7,2.6,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,2.7,1.6,2,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9,1.9) #change to absorbable zinc based on Matt's data
ear$Iron=c(5.2,7.2,20.9,25.7,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,42.8,31.4,26.5,26.5,26.5,26.5,26.5,26.5,16.6,14.1,14.1,14.1,14.1,14.1,14.1)#values for 5% bioavailability based on Matt's data
ear = ear %>% 
  mutate(age_range = paste(from, to, sep="-")) %>% 
  mutate(age_range = recode(age_range, "80-+" = "80+")) %>% 
  mutate(age_sex = paste(age_range, sex, sep="_")) %>% 
  select(-from, -to, -age_range, -sex) 

ear = reshape2::melt(ear, id.vars = c("age_sex"), measure.vars = names(ear)[1:(ncol(ear)-1)])

ear = ear %>%
  rename(nutrient = variable, EAR = value)

###Merge GENuS and EAR and calculate intake/(EAR*1.5)
genus_nutrient = genus_nutrient_supplies_by_age_sex_2011 %>% 
  mutate(age_sex = paste(age_range, sex, sep="_")) %>% 
  filter(nutrient %in% c("Iron", "Vitamin A", "Zinc")) %>% 
  select(country_use, iso3_use, age_sex, nutrient, value_med)

genus_nutrient = left_join(genus_nutrient, ear, by=c("age_sex" = "age_sex", "nutrient" = "nutrient"))

genus_nutrient = genus_nutrient %>% 
  mutate(vulnerability = value_med/(EAR))

##Calculate_Iron_def_population
genus_iron = genus_nutrient %>% 
  filter(nutrient =="Iron") %>% 
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  mutate(vulnerability_binary=if_else(vulnerability<1,1,0))%>%
  group_by(country_use) %>% 
  summarize(total_vulnerability = sum(vulnerability_binary)*100/32)%>%
rename(country = country_use, total_vulnerability_iron =total_vulnerability)

##Get a table for Iron
genus_iron_table=genus_nutrient %>%
  filter(nutrient =="iron") %>% 
  mutate(vulnerability_binary=if_else(vulnerability<1,1,0))%>%
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  spread(age_sex, vulnerability)
#write.csv(genus_iron_table, "intake_1_5_EAR_iron.csv", row.names=FALSE)

##Calculate_zinc_def_population
genus_zinc = genus_nutrient %>% 
  filter(nutrient =="Zinc") %>% 
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  mutate(vulnerability_binary=if_else(vulnerability<1,1,0))%>%
  group_by(country_use) %>% 
  summarize(total_vulnerability = sum(vulnerability_binary)*100/32)%>%
 rename(country= country_use, total_vulnerability_zinc =total_vulnerability)

##Get a table for Zinc
genus_zinc_table = genus_nutrient %>% 
  filter(nutrient =="Zinc") %>% 
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  spread(age_sex, vulnerability)
#write.csv(genus_zinc_table, "intake_1_5_EAR_zinc.csv", row.names=FALSE)

##Calculate_vitA_def_population
genus_vitA = genus_nutrient %>% 
  filter(nutrient =="Vitamin A") %>% 
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  mutate(vulnerability_binary=if_else(vulnerability<1,1,0))%>%
  group_by(country_use) %>% 
  summarize(total_vulnerability = sum(vulnerability_binary)*100/32)%>%
rename(country = country_use, total_vulnerability_vitA =total_vulnerability)
##Get a table for Vitamin A
genus_vitA_table = genus_nutrient %>% 
  filter(nutrient =="Vitamin A") %>% 
  select(country_use, iso3_use, age_sex, vulnerability) %>% 
  spread(age_sex, vulnerability)
#write.csv(genus_vitA_table, "intake_1_5_EAR_vitA.csv", row.names=FALSE)


#merge all nutrients
tot_vul = left_join(genus_iron, genus_zinc, by=c("country"))
tot_vul=left_join(tot_vul, genus_vitA, by=c("country"))
tot_vul=tot_vul %>%  group_by(country,total_vulnerability_iron,total_vulnerability_zinc,total_vulnerability_vitA) %>% 
  summarize(limiting=max(total_vulnerability_iron,total_vulnerability_zinc,total_vulnerability_vitA))

All_countries=left_join(tot_vul,prop_asf,by=c("country"))
# as.numeric(All_countries$marine)
# as.numeric(All_countries$asf_above_20_perc)
All_countries=All_countries %>%
  mutate(composite=if_else(limiting>10,marine_condition+freshwater_condition,0),
         limiting_nutrient_vulnerability = if_else(limiting<50, 0, 
                                                  if_else(limiting>75, 2, 1)),
         iron_vulnerability = if_else(total_vulnerability_iron<50, 0, 
                                                   if_else(total_vulnerability_iron>75, 2, 1)),
         zinc_vulnerability = if_else(total_vulnerability_zinc<50, 0, 
                                      if_else(total_vulnerability_zinc>75, 2, 1)),
         vitA_vulnerability = if_else(total_vulnerability_vitA<50, 0, 
                                      if_else(total_vulnerability_vitA>75, 2, 1)),
         Nutritional_dependence_and_vulnerability = composite*limiting_nutrient_vulnerability,
         iron_dependence_and_vulnerability = composite*iron_vulnerability,
         zinc_dependence_and_vulnerability = composite*zinc_vulnerability,
         vitA_dependence_and_vulnerability = composite*vitA_vulnerability)  #criteria above 10% considered vulnerable


All_countries=All_countries[c("country","iso3_use",names(All_countries)[c(-1,-6)])]  #change order of columns

write.csv(All_countries, "Global Nutrient Vulnerability and Seafood Dependence.csv", row.names=FALSE)

##-------------------------Filter for Africa
Africa=readRDS(file="~/MPA_Nutrition/AfricaCountries.rda")
Tanzania = as.data.frame("Tanzania")
colnames(Tanzania) = "country"
Africa = rbind(Africa, Tanzania)
Africa=Africa$country


 Africa_set=All_countries %>% 
  filter(country %in% Africa)

write.csv(Africa_set, "Africa.csv", row.names=FALSE)










