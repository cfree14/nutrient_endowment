#zinc_absorption_tidyverse <- function(zinc_phytate_table,genus_nutrient_supplies_by_cntry_food_2011 ) {
  #Miller equation for calculting absorbed zinc (TAZ) as a function of ingested
  #zinc(TDZ) and ingested phytate (TDP). Units of inputs and coefficients are
  #in millimole per day. Equation derived from A Mathematical Model of Zinc Absorption
  #in Humans As a Function of Dietary Zinc, Miller et al, 2007, J. Nutr. 137: 135-141, 2007.
  #Updated coefficiencts from Zinc bioavailability and homeostasis, Hambidge et al, Am J Clin Nutr 2010;91(suppl):1478S-83S.
 

phytateM<-660.4; #mg/millimole because phytate has a molecular weight of 660.4 g/mol
zincM<-65.38;#mg/millimole because zinc has a molecular weight of 65.38 g/mol

genus_nutrient_supplies_by_age_sex_2011_zincAbsorbe <-readRDS("C:/Users/Daniel/Google Drive/MPAs and Human Nutrition/Data/Nutrition Data/Human Dietary and Nutrition Data/GENuS Data/clean/genus_nutrient_supplies_w_fort_by_age_sex_2011.Rds") %>%
filter(nutrient %in% c("Zinc"))%>%   
mutate(value_med_milimole=value_med/zincM) %>%  #convert zinc to milimole
  mutate(value_lo_milimole=value_lo/zincM) %>%  #convert zinc to milimole
  mutate(value_hi_milimole=value_hi/zincM)    #convert zinc to milimole

zinc_phytate_table <- readRDS("~/Fisheries-Nutrition-Modeling/Nutrient Vulnerability/zinc_phytate_table.Rda")
edible_per_age_sex_2011 <- readRDS("C:/Users/Daniel/Google Drive/MPAs and Human Nutrition/Data/Nutrition Data/Human Dietary and Nutrition Data/GENuS Data/clean/genus_edible_food_by_age_sex_2011.Rds")

  edible_phytate<-left_join(edible_per_age_sex_2011,zinc_phytate_table,by=c("food"="food_type"))
  edible_phytate<-edible_phytate[ , !names(edible_phytate) %in% c("zinc")]%>%    #remove zinc column
  rename(phytate_density_mg_per100g=phytate)%>%
    mutate(phytate_density_mg_per100g = coalesce(phytate_density_mg_per100g, 0),value_med = coalesce(value_med, 0)) %>%  #convert nan to 0
    mutate(phytate_intake=phytate_density_mg_per100g*value_med/100)%>%
   group_by(country_use,age_range,sex) %>% 
    summarize(phytate_intake_all_milimole = sum(phytate_intake)/phytateM)
  
  phytate_zinc_age_sex=left_join(genus_nutrient_supplies_by_age_sex_2011_zincAbsorbe,edible_phytate, by=c("country_use"="country_use","age_range" = "age_range", "sex" = "sex"))
  phytate_zinc_age_sex=phytate_zinc_age_sex[setdiff(names(phytate_zinc_age_sex), c("iso3_use","iso3_use","nutrient_type","nutrient_label","country_orig","units_short"))]
  Amax<-0.091;#+-0.007
  Kp<-0.68;#+-0.22
  Kr<-0.033;#+-0.01
  phytate_zinc_age_sex=phytate_zinc_age_sex%>%
  mutate(TAZ1=0.5*(Amax+value_med_milimole+Kr*(1+phytate_intake_all_milimole/Kp)-sqrt((Amax+value_med_milimole+Kr*(1+phytate_intake_all_milimole/Kp))^2-4*Amax*value_med_milimole)))%>%
  mutate(zinc_absorb_mg=TAZ1*zincM)
 To_replace_zinc=phytate_zinc_age_sex[,c("country_use","age_range","sex","zinc_absorb_mg","nutrient")]
         
  
